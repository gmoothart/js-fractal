<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" media="all" href="960.css" />
    <style>
      body {
        background-color: #123;
      }
      .container_12 {
        background-color: white;
      }

      .crosshair{
        cursor: crosshair;
      }
    </style>
  </head>
  <body>
    <div class="container_12">
      <div class="grid_12">
        <h1>Fractal Viewer</h1>
        <fieldset>
          <legend>Mandelbrot</legend>
          <button id="mandelZoom">Zoom</button>
          <button id="mandelReset">Reset</button>
          <input id="mandelOverlay" type="checkbox" />
          <label for="mandelOverlay">Overlay Julia Set</label>
        </fieldset>
      </div>
      <div class="clear"></div>
      <div class="grid_11" style="height:600px;">
        <canvas id="c" width=800 height="600" style="position:absolute;z-index:0" ></canvas>
        <canvas id="overlayCanvas" width=800 height="600" style="position:absolute;z-index:1" ></canvas>
      </div>
      <div class="grid_1">
          <!-- Placeholder for fractal menu -->
      </div>
      <div class="clear"></div>
    </div>
      <script data-main="./" src="require.js"></script>
      <script src="jquery-1.7.1.js"></script>
      <script>
          var overlay = $('#overlayCanvas'),
              world = {
                  width: overlay.width(),
                  height: overlay.height(),
                  minR: -2.5,
                  maxR: 1.5,
                  minI: -1.5,
                  maxI: 1.5,
              },
              previewWorld = {
                  width: 80,
                  height: 60,
                  minR: -2.5,
                  maxR: 1.5,
                  minI: -1.5,
                  maxI: 1.5,
              },
              overlayCtx = overlay[0].getContext('2d'),
              isDragging = false,
              rectXStart, rectYStart,
              rectXEnd, rectYEnd,
              selectionEvents = {
                  'mousedown.selection': function(ev) {
                      isDragging = true;

                      rectXStart = ev.offsetX;
                      rectYStart = ev.offsetY;
                  },
                  'mouseup.selection mouseout.selection': function(ev) {
                      isDragging = false;
                  },
                  'mousemove.selection': function(ev) {
                      if (isDragging) {
                          rectXEnd = ev.offsetX;

                          // constrain selection to canvas aspect ration
                          if (ev.offsetY > rectYStart) {
                            rectYEnd = rectYStart + 3*(Math.abs(rectXStart - ev.offsetX)) / 4;
                          }
                          else {
                            rectYEnd = rectYStart - 3*(Math.abs(rectXStart - ev.offsetX)) / 4;
                          }

                          overlayCtx.clearRect(0,0,world.width, world.height);
                          overlayCtx.strokeStyle = '#6699ff';
                          overlayCtx.beginPath();
                          overlayCtx.moveTo(rectXStart, rectYStart);
                          overlayCtx.lineTo(rectXStart, rectYEnd);
                          overlayCtx.lineTo(rectXEnd, rectYEnd);
                          overlayCtx.lineTo(rectXEnd, rectYStart);
                          overlayCtx.lineTo(rectXStart, rectYStart);
                          overlayCtx.stroke();
                      }
                  }
              },
              juliaOverlayEvents = {
                  'mousemove.juliaOverlay': function(ev) {

                      require(['mandelbrot'], function(mandelbrot) {
                          var ctx,
                              imgData,
                              startR = mandelbrot.mapPixelToComplexCoord(ev.offsetX, world.width, world.minR, world.maxR),
                              startI = mandelbrot.mapPixelToComplexCoord(ev.offsetY, world.height, world.minI, world.maxI);


                          console.log('draw overlay at (' + startR + ',' + startI + ')');

                          ctx = $('#c')[0].getContext('2d'),
                          imgData = ctx.createImageData(previewWorld.width, previewWorld.height);

                          // show julia preview
                          mandelbrot.computeJulia(previewWorld, startR, startI,
                            function(x,y,rgbArr) { drawToImageData(imgData.data,previewWorld.width,x,y,rgbArr); },
                            setColorGrayscale);

                          ctx.putImageData(imgData, 0, 0);
                      });
                  },
                  'click.juliaOverlay': function(ev) {
                      // switch to Julia set
                      Julia.draw(ev.offsetX, ev.offsetY);

                  }
              }

          overlay.on(selectionEvents);
          $('#mandelZoom').on('click', function(ev) {

              require(['mandelbrot'], function(mandelbrot) {
                  var ctx,
                      imgData;

                  updateWorld(mandelbrot.mapPixelToComplexCoord, rectXStart, rectYStart, rectXEnd, rectYEnd);

                  ctx = $('#c')[0].getContext('2d'),
                  imgData = ctx.createImageData(800,600);


                  mandelbrot.compute(world, 
                    function(x,y,rgbArr) { drawToImageData(imgData.data,world.width,x,y,rgbArr); },
                    setColorGrayscale);

                  ctx.putImageData(imgData, 0, 0);

                  // clear selection box
                  overlayCtx.clearRect(0,0,world.width,world.height);
              });
          });

          $('#mandelReset').on('click', function(ev) {
              require(['mandelbrot'], function(mandelbrot) {
                  var ctx,
                      imgData;

                  resetWorld();

                  ctx = $('#c')[0].getContext('2d'),
                  imgData = ctx.createImageData(800,600);


                  mandelbrot.compute(world, 
                    function(x,y,rgbArr) { drawToImageData(imgData.data,world.width,x,y,rgbArr); },
                    setColorGrayscale);

                  ctx.putImageData(imgData, 0, 0);

                  // clear selection box
                  overlayCtx.clearRect(0,0,world.width,world.height);
              });

          });

          $('#mandelOverlay').on('change', function(ev) {
              //
              // Toggle between rectangle-selection zoom and julia ovelay mode
              //
              overlayCtx.clearRect(0,0,world.width,world.height);
              overlay.toggleClass('crosshair');

              if ($(ev.currentTarget).is(':checked')) {
                  overlay.off('.selection');
                  overlay.on(juliaOverlayEvents);
              }
              else {
                  overlay.on(selectionEvents);
                  overlay.off('.juliaOveraly');
              }
          });

        function updateWorld(mapFn, newx1, newy1, newx2, newy2) {
            var r1 = mapFn(newx1, world.width, world.minR, world.maxR),
                i1 = mapFn(newy1, world.height, world.minI, world.maxI),
                r2 = mapFn(newx2, world.width, world.minR, world.maxR),
                i2 = mapFn(newy2, world.height, world.minI, world.maxI);

            if (r1 > r2) {
                world.maxR = r1;
                world.minR = r2;
            }
            else {
                world.maxR = r2;
                world.minR = r1;
            }

            if (i1 > i2) {
                world.minI = i2;
                world.maxI = i1;
            }
            else {
                world.minI = i1;
                world.maxI = i2;
            }
        }

        function resetWorld() {
            world.minR = -2.5;
            world.maxR = 1.5;
            world.minI = -1.5;
            world.maxI = 1.5;
        }

        function setColorGrayscale(iter, maxIter) {
            // normalize to a 0..255 range
            var norm = Math.floor(255 * iter/maxIter);

            // simple, just scale smoothly from white to black
            return [norm, norm, norm, 255];
        }

        function drawToImageData(pixelArr, width, x, y, rgbArr) {

              var pos = (y*width + x) * 4;

              pixelArr[pos + 0] = rgbArr[0]; // R
              pixelArr[pos + 1] = rgbArr[1]; // G
              pixelArr[pos + 2] = rgbArr[2]; // B
              pixelArr[pos + 3] = rgbArr[3]; // Alpha
        }


        // draw the full set
        require(['mandelbrot'], function(mandelbrot) {

          var ctx = $('#c')[0].getContext('2d'),
              imgData = ctx.createImageData(800,600);

          mandelbrot.compute(world, 
            function(x,y,rgbArr) { drawToImageData(imgData.data, world.width, x, y, rgbArr); },
            setColorGrayscale);

          ctx.putImageData(imgData, 0, 0);
        });

      </script>
  </body>
</html>
