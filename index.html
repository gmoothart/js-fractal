<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" media="all" href="960.css" />
    <style>
      body {
        background-color: #123;
      }
      .container_12 {
        background-color: white;
      }

      .crosshair{
        cursor: crosshair;
      }
    </style>
  </head>
  <body>
    <div class="container_12">
      <div class="grid_12">
        <h1>Fractal Viewer</h1>
        <fieldset>
          <legend>Mandelbrot</legend>
          <button id="mandelZoom">Zoom</button>
          <input id="mandelOverlay" type="checkbox" />
          <label for="mandelOverlay">Overlay Julia Set</label>
        </fieldset>
      </div>
      <div class="clear"></div>
      <div class="grid_11" style="height:600px;">
        <canvas id="c" width=800 height="600" style="position:absolute;z-index:0" ></canvas>
        <canvas id="overlayCanvas" width=800 height="600" style="position:absolute;z-index:1" ></canvas>
      </div>
      <div class="grid_1">
          <!-- Placeholder for fractal menu -->
      </div>
      <div class="clear"></div>
    </div>
      <script data-main="./" src="require.js"></script>
      <script src="jquery-1.7.1.js"></script>
      <script>
          var overlay = $('#overlayCanvas'),
              w = overlay.width(),
              h = overlay.height(),
              minR = -2.5, maxR = 1.5,
              minI = -1.5, maxI = 1.5,
              ctx = overlay[0].getContext('2d'),
              isDragging = false,
              rectXStart, rectYStart,
              rectXEnd, rectYEnd,
              selectionEvents = {
                  'mousedown.selection': function(ev) {
                      isDragging = true;

                      rectXStart = ev.offsetX;
                      rectYStart = ev.offsetY;
                  },
                  'mouseup.selection mouseout.selection': function(ev) {
                      isDragging = false;
                  },
                  'mousemove.selection': function(ev) {
                      if (isDragging) {
                          rectXEnd = ev.offsetX;

                          // constrain selection to canvas aspect ration
                          if (ev.offsetY > rectYStart) {
                            rectYEnd = rectYStart + 3*(Math.abs(rectXStart - ev.offsetX)) / 4;
                          }
                          else {
                            rectYEnd = rectYStart - 3*(Math.abs(rectXStart - ev.offsetX)) / 4;
                          }

                          ctx.clearRect(0,0,w,h);
                          ctx.strokeStyle = '#6699ff';
                          ctx.beginPath();
                          ctx.moveTo(rectXStart, rectYStart);
                          ctx.lineTo(rectXStart, rectYEnd);
                          ctx.lineTo(rectXEnd, rectYEnd);
                          ctx.lineTo(rectXEnd, rectYStart);
                          ctx.lineTo(rectXStart, rectYStart);
                          ctx.stroke();
                      }
                  }
              },
              juliaOverlayEvents = {
                  'mousemove.juliaOverlay': function(ev) {
                      // show julia preview
                      Julia.draw(ev.offsetX, ev.offsetY);

                  },
                  'mousemove.juliaOverlay': function(ev) {
                      // switch to Julia set
                      Julia.draw(ev.offsetX, ev.offsetY);

                  }
              }

          overlay.on(selectionEvents);
          $('#mandelZoom').on('click', function(ev) {

              require(['mandelbrot'], function(mandelbrot) {
                  var r1 = mandelbrot.mapPixelToComplexCoord(rectXStart, w, minR, maxR),
                      r2 = mandelbrot.mapPixelToComplexCoord(rectXEnd, w, minR, maxR),
                      i1 = mandelbrot.mapPixelToComplexCoord(rectYStart, h, minI, maxI),
                      i2 = mandelbrot.mapPixelToComplexCoord(rectYEnd, h, minI, maxI),
                      ctx,
                      imgData;

                  if (r1 > r2) {
                      maxR = r1;
                      minR = r2;
                  }
                  else {
                      maxR = r2;
                      minR = r1;
                  }

                  if (i1 > i2) {
                      minI = i2;
                      maxI = i1;
                  }
                  else {
                      minI = i1;
                      maxI = i2;
                  }

                  ctx = $('#c')[0].getContext('2d'),
                  imgData = ctx.createImageData(800,600);

                  mandelbrot.drawTo(imgData, minR, minI, maxR, maxI );
                  ctx.putImageData(imgData, 0, 0);
              });
          });

          $('#mandelOverlay').on('change', function(ev) {
              //
              // Toggle between rectangle-selection zoom and julia ovelay mode
              //
              ctx.clearRect(0,0,w,h);
              overlay.toggleClass('crosshair');

              if ($(ev.currentTarget).is(':checked')) {
                  overlay.off('.selection');
                  overlay.on(juliaOverlayEvents);
              }
              else {
                  overlay.on(selectionEvents);
                  overlay.off('.juliaOveraly');
              }
          });


        require(['mandelbrot'], function(mandelbrot) {

          // draw axes
          // x-axis is the line from (minR,0) to (maxR,0) and
          // y-axis is the line from (minI,0) to (maxI,0)
          // We need to map that to pixel coordinates
          var originX = mandelbrot.mapComplexCoordToPixel(0, w, minR, maxR),
              originY = mandelbrot.mapComplexCoordToPixel(0, h, minI, maxI),
              ctx = $('#c')[0].getContext('2d'),
              imgData = ctx.createImageData(800,600);


          ctx.strokeStyle = '#6699ff';
          ctx.beginPath();
          ctx.moveTo(0,originY);
          ctx.lineTo(w,originY); // x-axis
          ctx.moveTo(originX,0);
          ctx.lineTo(originX,h); // y-axis
          ctx.stroke();

          mandelbrot.drawTo(imgData, minR, minI, maxR, maxI );
          ctx.putImageData(imgData, 0, 0);
        });
      </script>
  </body>
</html>
